<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Sample of websocket with golang</title>

        <style media="screen">
            .hidden { display: none !important; }

            .client {
                width: 500px;
                height: 200px;
                padding: 11px 10px;
                display: table-cell;
                border: 1px solid #aaa;
                position: relative;
                font-family: sans-serif;
            }
            .msg-list {
                list-style: none;
                margin-left: 0;
                padding-left: 0;
                margin-top: 0;
                padding-top: 0;
                height: 181px;
                overflow-y: scroll;
                overflow-x: auto;
            }
            .msg-list li {
                list-style: none;
                margin-left: 0;
                padding-left: 0;
                margin-bottom: 15px;
            }
            .msg-list .from-line {
                font-weight: bold;
                display: block;
                height: 19px;
            }
            .from-line .from-icon {
                height: 31px;
            }
            .from-line .from-text {
                vertical-align: top;
                margin-left: 10px;
                display: inline-block;
                font-size: 13px;
            }
            .message-body {
                display: block;
                margin-left: 40px;
                font-family: serif;
            }
            .client .compose-input {
                width: 97.5%;
                position: absolute;
                bottom: 0;
                margin: 0;
                left: 0;
                height: 24px;
                font-size: 15px;
                padding: 0px 4px;
                border-color: #ccc;
            }
        </style>

        <script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>

        <script>
          function handleSendMessage(selector, ws) {
              var data = $('.compose-input', selector).val();
              $('.compose-input', selector).val('');
              var to = 'all';
              var msg = {to: to, data: data}
              ws.send(JSON.stringify(msg));
              console.log("sending:", msg);
          }
          function onMessage(e, ws, $ul) {
              var data = JSON.parse(event.data)
              console.log("received:", data);
              var $from = $('<span class="from-line">');
              $from.
                  append($('<img src="speech-bubble.svg" alt="Speech bubble icon" class="from-icon">')).
                  append($('<span class="from-text">').text(data.fromName))
              var $messageBody = $('<span>').addClass('message-body');
              $messageBody.text(data.data);
              $('<li>').
                  append($from).
                  append($messageBody).
                  appendTo($ul);
              $ul[0].scrollTop = $ul[0].scrollHeight;
          }
          function buildClient(userName, selector) {
              return function() {
                  var ws = new WebSocket("ws://localhost:8080/echo");
                  ws.onopen = function() {
                      console.log("Connected. Registering...");

                      // Register
                      var msg = {action: 'set-name', data: userName};
                      ws.send(JSON.stringify(msg));

                      var $ul = $('.msg-list', selector);
                      console.log("$ul:", $ul);
                      ws.onmessage = function(e) {
                          onMessage(e, ws, $ul);
                      }
                      $('.compose-input', selector).
                          keypress(function(e) {
                              if(e.which == 13) {
                                  handleSendMessage(selector, ws);
                              }
                          }).
                          focus();
                  }
              }
          }
          function handleRegister(selector) {
              var userName = $('.name-input', selector).val().trim();
              if (userName.length == 0) {
                  alert("Please choose a name");
                  return;
              }

              $(selector).addClass('hidden');
              $('#client').removeClass('hidden');
              $(buildClient(userName, "#client"));
          }
          function buildRegistration(selector) {
              console.log("name-input:", $('.name-input', selector));
              $('.name-input', selector).
                  keypress(function(e) {
                      if(e.which == 13) {
                          handleRegister(selector);
                      }
                  }).
                  focus();
          }

          $(document).ready(function() {
              buildRegistration('#registration');
          });
        </script>
    </head>
    <body>
        <div id="registration" class="registration">
            <p>
                Welcome to the chat room.
            </p>
            <label>
                What name shall you be known as?
                <input type="text" class="name-input" name="name" value="">
            </label>
        </div>
        <div id="client" class="client hidden">
            <ul class="msg-list"></ul>
            <input type="text" class="compose-input" />
        </div>
    </body>
</html>
